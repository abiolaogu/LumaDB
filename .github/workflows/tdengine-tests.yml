name: TDengine Compatibility Tests

on:
  push:
    branches: [main, release/*]
    paths:
      - 'go-cluster/pkg/tdengine/**'
      - 'rust-core/src/tdengine/**'
      - 'tests/tdengine*'
  pull_request:
    branches: [main]
    paths:
      - 'go-cluster/pkg/tdengine/**'
      - 'rust-core/src/tdengine/**'
      - 'tests/tdengine*'

env:
  GO_VERSION: '1.21'
  RUST_VERSION: 'stable'

jobs:
  rust-tests:
    name: Rust TDengine Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, nightly]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy, rustfmt
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust-core/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Rust TDengine tests
        working-directory: rust-core
        run: |
          cargo test tdengine --all-features -- --nocapture
      
      - name: Run clippy
        working-directory: rust-core
        run: cargo clippy --all-features -- -D warnings
        continue-on-error: true

  go-tests:
    name: Go TDengine Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: Download dependencies
        working-directory: go-cluster
        run: go mod download
      
      - name: Run Go TDengine tests
        working-directory: go-cluster
        run: |
          go test ./pkg/tdengine/... -v -race -coverprofile=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: go-cluster/coverage.out
          flags: tdengine
          name: tdengine-coverage
        continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [rust-tests, go-tests]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build LumaDB
        run: |
          cd rust-core && cargo build --release
          cd ../go-cluster && go build ./...
      
      - name: Run integration tests
        run: |
          cd tests
          go test -v -tags=integration ./... -timeout 5m
      
      - name: Run TDengine compatibility tests
        run: |
          go test -v ./tests/tdengine_integration_test.go -timeout 5m

  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run benchmarks
        run: |
          cd tests
          go test -bench=BenchmarkTDengine -benchmem -count=5 > benchmark.txt
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: tests/benchmark.txt
      
      - name: Check performance regression
        run: |
          # Compare with baseline (if available)
          if [ -f .github/benchmarks/baseline.txt ]; then
            go install golang.org/x/perf/cmd/benchstat@latest
            benchstat .github/benchmarks/baseline.txt tests/benchmark.txt
          else
            echo "No baseline found, skipping comparison"
          fi
        continue-on-error: true

  client-compatibility:
    name: TDengine Client Compatibility
    runs-on: ubuntu-latest
    needs: [integration-tests]
    
    strategy:
      matrix:
        client:
          - name: go-client
            script: test-go-client.sh
          - name: python-connector
            script: test-python-client.sh
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Start LumaDB in TDengine mode
        run: |
          cd go-cluster
          go run ./cmd/server/main.go --tdengine-compat &
          sleep 5
      
      - name: Test ${{ matrix.client.name }}
        run: |
          if [ -f .github/scripts/${{ matrix.client.script }} ]; then
            bash .github/scripts/${{ matrix.client.script }}
          else
            echo "Client test script not found, skipping"
          fi
        continue-on-error: true
